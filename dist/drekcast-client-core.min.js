/*! drekcast-client-core 21-03-2014 */
"use strict";function BaseConnector(){this.callback=void 0}!function(a,b){function c(a){this._currentChannel=void 0,this._connector=void 0,a&&this._loadConfig(a)}function d(){this.callback=void 0}var e=[],f=(e.push,e.slice),g=(e.splice,{on:function(a,b,c){if(!i(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,c,d){if(!i(this,"once",a,[c,d])||!c)return this;var e=this,f=b.once(function(){e.off(a,f),c.apply(this,arguments)});return f._callback=c,this.on(a,f,d)},off:function(a,c,d){var e,f,g,h,j,k,l,m;if(!this._events||!i(this,"off",a,[c,d]))return this;if(!a&&!c&&!d)return this._events=void 0,this;for(h=a?[a]:b.keys(this._events),j=0,k=h.length;k>j;j++)if(a=h[j],g=this._events[a]){if(this._events[a]=e=[],c||d)for(l=0,m=g.length;m>l;l++)f=g[l],(c&&c!==f.callback&&c!==f.callback._callback||d&&d!==f.context)&&e.push(f);e.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=f.call(arguments,1);if(!i(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&j(c,b),d&&j(d,arguments),this},stopListening:function(a,c,d){var e=this._listeningTo;if(!e)return this;var f=!c&&!d;d||"object"!=typeof c||(d=this),a&&((e={})[a._listenId]=a);for(var g in e)a=e[g],a.off(c,d,this),(f||b.isEmpty(a._events))&&delete this._listeningTo[g];return this}}),h=/\s+/,i=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(h.test(c)){for(var f=c.split(h),g=0,i=f.length;i>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},j=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b);return}},k={listenTo:"on",listenToOnce:"once"};b.each(k,function(a,c){g[c]=function(c,d,e){var f=this._listeningTo||(this._listeningTo={}),g=c._listenId||(c._listenId=b.uniqueId("l"));return f[g]=c,e||"object"!=typeof d||(e=this),c[a](d,e,this),this}}),g.bind=g.on,g.unbind=g.off,b.extend(c.prototype,g),c.prototype._loadConfig=function(a){a.connector?this._connector=a.connector:a.serverAddress&&(this._connector=new l(a.serverAddress)),a.channel&&(this._currentChannel=a.channel)},c.prototype._checkConfig=function(a){if(!a.connector)throw Exception("No connector defined");return!0},c.prototype.connect=function(){this._initConnector(),this._startConnector()},c.prototype.disconnect=function(){},c.prototype._initConnector=function(){var a=this;this._connector.setCallback(function(b,c){a.trigger(b,c)})},c.prototype._startConnector=function(){this._connector.connect(),this._currentChannel&&this._connector.join(this._currentChannel)},c.prototype.send=function(a,b){return this._connector.send(a,b)},c.prototype.setChannel=function(a){this._currentChannel&&this._connector.leave(this._currentChannel),this._connector.join(a),this._currentChannel=a},c.prototype.setScreen=function(a,b){this._ensureChannelJoined(),b=b||{},this._connector.send("setScreen",{screen:a,options:b})},c.prototype.toggleOverlay=function(a,b,c){this._ensureChannelJoined(),c=c||{},this._connector.send("toggleOverlay",{overlay:a,visible:b,options:c})},c.prototype._ensureConnected=function(){},c.prototype._ensureChannelJoined=function(){this._ensureConnected()},c.log=function(){console.log(arguments)},d.prototype.connect=function(){console.error("connector.connect() not implemented")},d.prototype.disconnect=function(){console.error("connector.disconnect() not implemented")},d.prototype.send=function(){console.error("connector.send() not implemented")},d.prototype.setCallback=function(a){this.callback=a},d.prototype.join=function(){console.error("connector.join() not implemented")},d.prototype.leave=function(){console.error("connector.leave() not implemented")};var l=function(a,b){d.call(this),this.url=a,this.options=b};return l.prototype=new d,l.prototype.connect=function(a,b){var c=this.url+"?type="+a+"&token="+b;this.primus=new Primus(c,this.options);var d=this;this.primus.on("data",function(a){d.callback&&d.callback.call(this,a[0],a[1]||{})})},l.prototype.send=function(a,c){var d=b.assign({action:a},c);this.primus.write(d)},l.prototype.join=function(a){this.primus.write({action:"join",channel:a})},l.prototype.leave=function(a){this.primus.write({action:"leave",channel:a})},a.DrekCastClient=c,c}(window,_),BaseConnector.prototype.connect=function(){console.error("connector.connect() not implemented")},BaseConnector.prototype.disconnect=function(){console.error("connector.disconnect() not implemented")},BaseConnector.prototype.send=function(){console.error("connector.send() not implemented")},BaseConnector.prototype.setCallback=function(a){this.callback=a},BaseConnector.prototype.join=function(){console.error("connector.join() not implemented")},BaseConnector.prototype.leave=function(){console.error("connector.leave() not implemented")};var PrimusConnector=function(a,b){BaseConnector.call(this),this.url=a,this.options=b};PrimusConnector.prototype=new BaseConnector,PrimusConnector.prototype.connect=function(a,b){var c=this.url+"?type="+a+"&token="+b;this.primus=new Primus(c,this.options);var d=this;this.primus.on("data",function(a){d.callback&&d.callback.call(this,a[0],a[1]||{})})},PrimusConnector.prototype.send=function(a,b){var c=_.assign({action:a},b);this.primus.write(c)},PrimusConnector.prototype.join=function(a){this.primus.write({action:"join",channel:a})},PrimusConnector.prototype.leave=function(a){this.primus.write({action:"leave",channel:a})};var array=[],push=array.push,slice=array.slice,splice=array.splice,Events={on:function(a,b,c){if(!eventsApi(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!eventsApi(this,"once",a,[b,c])||!b)return this;var d=this,e=_.once(function(){d.off(a,e),b.apply(this,arguments)});return e._callback=b,this.on(a,e,c)},off:function(a,b,c){var d,e,f,g,h,i,j,k;if(!this._events||!eventsApi(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events=void 0,this;for(g=a?[a]:_.keys(this._events),h=0,i=g.length;i>h;h++)if(a=g[h],f=this._events[a]){if(this._events[a]=d=[],b||c)for(j=0,k=f.length;k>j;j++)e=f[j],(b&&b!==e.callback&&b!==e.callback._callback||c&&c!==e.context)&&d.push(e);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=slice.call(arguments,1);if(!eventsApi(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&triggerEvents(c,b),d&&triggerEvents(d,arguments),this},stopListening:function(a,b,c){var d=this._listeningTo;if(!d)return this;var e=!b&&!c;c||"object"!=typeof b||(c=this),a&&((d={})[a._listenId]=a);for(var f in d)a=d[f],a.off(b,c,this),(e||_.isEmpty(a._events))&&delete this._listeningTo[f];return this}},eventSplitter=/\s+/,eventsApi=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(eventSplitter.test(c)){for(var f=c.split(eventSplitter),g=0,h=f.length;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},triggerEvents=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b);return}},listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(a,b){Events[b]=function(b,c,d){var e=this._listeningTo||(this._listeningTo={}),f=b._listenId||(b._listenId=_.uniqueId("l"));return e[f]=b,d||"object"!=typeof c||(d=this),b[a](c,d,this),this}}),Events.bind=Events.on,Events.unbind=Events.off;